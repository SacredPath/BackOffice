<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - Admin Dashboard</title>
    <style>
        :root {
            --primary-color: #4F46E5;
            --primary-dark: #4338CA;
            --secondary-color: #10B981;
            --danger-color: #EF4444;
            --warning-color: #F59E0B;
            --dark-bg: #1F2937;
            --darker-bg: #111827;
            --light-bg: #374151;
            --text-primary: #F9FAFB;
            --text-secondary: #D1D5DB;
            --border-color: #4B5563;
            --success-color: #10B981;
            --info-color: #3B82F6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--darker-bg);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            background: var(--dark-bg);
            border-right: 1px solid var(--border-color);
            padding: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            background: var(--light-bg);
            color: var(--text-primary);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            padding: 30px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        /* Search and Filters */
        .controls {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .search-box {
            flex: 1;
            min-width: 300px;
            position: relative;
        }

        .search-box input {
            width: 100%;
            padding: 12px 16px 12px 45px;
            background: var(--dark-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-secondary {
            background: var(--light-bg);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #DC2626;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: white;
        }

        /* User Table */
        .user-table {
            background: var(--dark-bg);
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-color);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th {
            background: var(--light-bg);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .table tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }

        .user-info-cell {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .user-email {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Status Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-color);
        }

        .badge-warning {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning-color);
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
        }

        .badge-info {
            background: rgba(59, 130, 246, 0.1);
            color: var(--info-color);
        }

        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            padding: 8px;
            border: none;
            border-radius: 6px;
            background: var(--light-bg);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-icon:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--dark-bg);
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 24px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 12px;
            background: var(--darker-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .controls {
                flex-direction: column;
            }
            
            .search-box {
                min-width: 100%;
            }
            
            .table {
                font-size: 14px;
            }
            
            .table th, .table td {
                padding: 12px 8px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2L2 7v10c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V7l-10-5z"/>
                </svg>
                Admin Dashboard
            </div>
            
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="dashboard-standalone.html" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7"/>
                                <rect x="14" y="3" width="7" height="7"/>
                                <rect x="14" y="14" width="7" height="7"/>
                                <rect x="3" y="14" width="7" height="7"/>
                            </svg>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="users.html" class="nav-link active">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Users
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            </svg>
                            Trading
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                <polyline points="14,2 14,8 20,8"/>
                                <line x1="16" y1="13" x2="8" y2="13"/>
                                <line x1="16" y1="17" x2="8" y2="17"/>
                                <polyline points="10,9 9,9 8,9"/>
                            </svg>
                            KYC
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <div class="header">
                <h1 class="page-title">User Management</h1>
                <div class="user-info">
                    <span id="adminName">Admin User</span>
                    <button class="btn btn-secondary" onclick="logout()">Logout</button>
                </div>
            </div>

            <!-- Search and Filters -->
            <div class="controls">
                <div class="search-box">
                    <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="11" cy="11" r="8"/>
                        <path d="m21 21-4.35-4.35"/>
                    </svg>
                    <input type="text" id="searchInput" placeholder="Search users by name, email...">
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-secondary" onclick="filterUsers('all')">All Users</button>
                    <button class="btn btn-warning" onclick="filterUsers('frozen')">Frozen</button>
                    <button class="btn btn-warning" onclick="filterUsers('kyc_pending')">KYC Pending</button>
                    <button class="btn btn-success" onclick="filterUsers('kyc_approved')">KYC Approved</button>
                </div>
                <button class="btn btn-primary" onclick="openNotificationModal()">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                        <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                    </svg>
                    Send Notification
                </button>
            </div>

            <!-- Users Table -->
            <div class="user-table">
                <table class="table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Status</th>
                            <th>KYC Status</th>
                            <th>Country</th>
                            <th>Joined</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Users will be loaded here -->
                    </tbody>
                </table>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="loading">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 1 1-6.219-8.56"/>
                </svg>
                <p>Loading users...</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                    <circle cx="9" cy="7" r="4"/>
                    <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                    <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                </svg>
                <h3>No users found</h3>
                <p>Try adjusting your search or filters</p>
            </div>
        </main>
    </div>

    <!-- Edit User Modal -->
    <div id="editUserModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit User</h2>
                <button class="modal-close" onclick="closeModal('editUserModal')">&times;</button>
            </div>
            <form id="editUserForm">
                <div class="form-group">
                    <label class="form-label">Display Name</label>
                    <input type="text" class="form-input" id="editDisplayName" required>
                </div>
                <div class="form-group">
                    <label class="form-label">First Name</label>
                    <input type="text" class="form-input" id="editFirstName">
                </div>
                <div class="form-group">
                    <label class="form-label">Last Name</label>
                    <input type="text" class="form-input" id="editLastName">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="tel" class="form-input" id="editPhone">
                </div>
                <div class="form-group">
                    <label class="form-label">Country</label>
                    <input type="text" class="form-input" id="editCountry">
                </div>
                <div class="form-group">
                    <label class="form-label">Bio</label>
                    <textarea class="form-textarea" id="editBio"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('editUserModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Notification Modal -->
    <div id="notificationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Send Notification</h2>
                <button class="modal-close" onclick="closeModal('notificationModal')">&times;</button>
            </div>
            <form id="notificationForm">
                <div class="form-group">
                    <label class="form-label">Send To</label>
                    <select class="form-select" id="notificationTarget">
                        <option value="selected">Selected Users</option>
                        <option value="all">All Users</option>
                        <option value="kyc_pending">Users with KYC Pending</option>
                        <option value="frozen">Frozen Users</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="notificationCategory">
                        <option value="system_announcement">System Announcement</option>
                        <option value="profile_updated">Profile Update</option>
                        <option value="kyc_approved">KYC Approved</option>
                        <option value="kyc_rejected">KYC Rejected</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Message</label>
                    <textarea class="form-textarea" id="notificationMessage" placeholder="Enter your message here..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('notificationModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Notification</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scripts -->
    <script src="env.js"></script>
    <script src="api.js"></script>
    <script src="modal.js"></script>
    <script src="users.js"></script>
    <script>
        let currentUsers = [];
        let selectedUsers = [];
        let currentFilter = 'all';
        let currentSearch = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthentication();
            loadUsers();
            setupEventListeners();
        });

        function checkAuthentication() {
            const authToken = sessionStorage.getItem('authToken');
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            
            if (!authToken || !isLoggedIn) {
                window.location.href = 'login.html';
                return;
            }

            // Set admin name
            const adminName = sessionStorage.getItem('adminName');
            document.getElementById('adminName').textContent = adminName || 'Admin User';
        }

        function setupEventListeners() {
            // Search
            document.getElementById('searchInput').addEventListener('input', function(e) {
                currentSearch = e.target.value;
                filterAndDisplayUsers();
            });

            // Edit user form
            document.getElementById('editUserForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveUserChanges();
            });

            // Notification form
            document.getElementById('notificationForm').addEventListener('submit', function(e) {
                e.preventDefault();
                sendNotification();
            });
        }

        async function loadUsers() {
            try {
                document.getElementById('loadingState').style.display = 'block';
                document.getElementById('emptyState').style.display = 'none';
                
                const users = await window.TradingAPI.getUsers(100, 0, currentSearch);
                currentUsers = users;
                
                filterAndDisplayUsers();
            } catch (error) {
                console.error('Failed to load users:', error);
                showError('Failed to load users. Please try again.');
            } finally {
                document.getElementById('loadingState').style.display = 'none';
            }
        }

        function filterAndDisplayUsers() {
            let filteredUsers = [...currentUsers];

            // Apply search filter
            if (currentSearch) {
                filteredUsers = filteredUsers.filter(user => 
                    user.email?.toLowerCase().includes(currentSearch.toLowerCase()) ||
                    user.display_name?.toLowerCase().includes(currentSearch.toLowerCase()) ||
                    user.first_name?.toLowerCase().includes(currentSearch.toLowerCase()) ||
                    user.last_name?.toLowerCase().includes(currentSearch.toLowerCase())
                );
            }

            // Apply status filter
            if (currentFilter === 'frozen') {
                filteredUsers = filteredUsers.filter(user => user.is_frozen);
            } else if (currentFilter === 'kyc_pending') {
                filteredUsers = filteredUsers.filter(user => user.kyc_status === 'not_submitted');
            } else if (currentFilter === 'kyc_approved') {
                filteredUsers = filteredUsers.filter(user => user.kyc_status === 'approved');
            }

            displayUsers(filteredUsers);
        }

        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '';
                document.getElementById('emptyState').style.display = 'block';
                return;
            }

            document.getElementById('emptyState').style.display = 'none';

            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>
                        <div class="user-info-cell">
                            <div class="user-avatar">
                                ${user.display_name?.charAt(0).toUpperCase() || user.email?.charAt(0).toUpperCase() || 'U'}
                            </div>
                            <div class="user-details">
                                <div class="user-name">${user.display_name || 'Unknown'}</div>
                                <div class="user-email">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td>
                        ${user.is_frozen ? 
                            '<span class="badge badge-danger">Frozen</span>' : 
                            '<span class="badge badge-success">Active</span>'
                        }
                    </td>
                    <td>
                        ${getKYCStatusBadge(user.kyc_status)}
                    </td>
                    <td>${user.country || 'N/A'}</td>
                    <td>${formatDate(user.created_at)}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-icon" onclick="editUser('${user.user_id}')" title="Edit">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                    <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                </svg>
                            </button>
                            ${user.is_frozen ? 
                                `<button class="btn-icon" onclick="unsuspendUser('${user.user_id}')" title="Unsuspend" style="color: var(--success-color);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/>
                                        <polyline points="22,4 12,14.01 9,11.01"/>
                                    </svg>
                                </button>` :
                                `<button class="btn-icon" onclick="suspendUser('${user.user_id}')" title="Suspend" style="color: var(--warning-color);">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"/>
                                        <line x1="8" y1="12" x2="16" y2="12"/>
                                    </svg>
                                </button>`
                            }
                            <button class="btn-icon" onclick="sendUserNotification('${user.user_id}')" title="Send Notification" style="color: var(--info-color);">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/>
                                    <path d="M13.73 21a2 2 0 0 1-3.46 0"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function getKYCStatusBadge(status) {
            const badges = {
                'approved': '<span class="badge badge-success">Approved</span>',
                'not_submitted': '<span class="badge badge-warning">Not Submitted</span>',
                'pending': '<span class="badge badge-info">Pending</span>',
                'rejected': '<span class="badge badge-danger">Rejected</span>'
            };
            return badges[status] || '<span class="badge badge-secondary">Unknown</span>';
        }

        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }

        function filterUsers(filter) {
            currentFilter = filter;
            filterAndDisplayUsers();
        }

        async function editUser(userId) {
            try {
                const users = await window.TradingAPI.getUserById(userId);
                const user = users[0];
                
                if (!user) {
                    showError('User not found');
                    return;
                }

                // Populate form
                document.getElementById('editDisplayName').value = user.display_name || '';
                document.getElementById('editFirstName').value = user.first_name || '';
                document.getElementById('editLastName').value = user.last_name || '';
                document.getElementById('editPhone').value = user.phone || '';
                document.getElementById('editCountry').value = user.country || '';
                document.getElementById('editBio').value = user.bio || '';
                
                // Store user ID for saving
                document.getElementById('editUserForm').dataset.userId = userId;
                
                // Open modal
                document.getElementById('editUserModal').classList.add('active');
            } catch (error) {
                console.error('Failed to load user:', error);
                showError('Failed to load user details');
            }
        }

        async function saveUserChanges() {
            try {
                const userId = document.getElementById('editUserForm').dataset.userId;
                
                const updates = {
                    display_name: document.getElementById('editDisplayName').value,
                    first_name: document.getElementById('editFirstName').value,
                    last_name: document.getElementById('editLastName').value,
                    phone: document.getElementById('editPhone').value,
                    country: document.getElementById('editCountry').value,
                    bio: document.getElementById('editBio').value
                };

                await window.TradingAPI.updateUser(userId, updates);
                
                closeModal('editUserModal');
                await loadUsers(); // Reload users
                
                showSuccess('User updated successfully');
            } catch (error) {
                console.error('Failed to update user:', error);
                showError('Failed to update user');
            }
        }

        async function suspendUser(userId) {
            if (!confirm('Are you sure you want to suspend this user?')) return;
            
            const reason = prompt('Please enter the reason for suspension:');
            if (!reason) return;

            try {
                await window.TradingAPI.suspendUser(userId, reason);
                await loadUsers();
                showSuccess('User suspended successfully');
            } catch (error) {
                console.error('Failed to suspend user:', error);
                showError('Failed to suspend user');
            }
        }

        async function unsuspendUser(userId) {
            if (!confirm('Are you sure you want to unsuspend this user?')) return;

            try {
                await window.TradingAPI.unsuspendUser(userId);
                await loadUsers();
                showSuccess('User unsuspended successfully');
            } catch (error) {
                console.error('Failed to unsuspend user:', error);
                showError('Failed to unsuspend user');
            }
        }

        function openNotificationModal() {
            document.getElementById('notificationModal').classList.add('active');
        }

        function sendUserNotification(userId) {
            selectedUsers = [userId];
            document.getElementById('notificationTarget').value = 'selected';
            openNotificationModal();
        }

        async function sendNotification() {
            try {
                const target = document.getElementById('notificationTarget').value;
                const category = document.getElementById('notificationCategory').value;
                const message = document.getElementById('notificationMessage').value;

                let userIds = [];
                
                if (target === 'selected') {
                    userIds = selectedUsers;
                } else if (target === 'all') {
                    userIds = currentUsers.map(user => user.user_id);
                } else if (target === 'kyc_pending') {
                    userIds = currentUsers.filter(user => user.kyc_status === 'not_submitted').map(user => user.user_id);
                } else if (target === 'frozen') {
                    userIds = currentUsers.filter(user => user.is_frozen).map(user => user.user_id);
                }

                if (userIds.length === 0) {
                    showError('No users found for the selected target');
                    return;
                }

                await window.TradingAPI.sendBulkNotifications(userIds, category, { message });
                
                closeModal('notificationModal');
                showSuccess(`Notification sent to ${userIds.length} user(s)`);
                
                // Clear form
                document.getElementById('notificationMessage').value = '';
                selectedUsers = [];
            } catch (error) {
                console.error('Failed to send notification:', error);
                showError('Failed to send notification');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showSuccess(message) {
            // Simple alert for now - you could implement a better toast system
            alert('Success: ' + message);
        }

        function showError(message) {
            // Simple alert for now - you could implement a better toast system
            alert('Error: ' + message);
        }

        function logout() {
            window.TradingAPI.signOut();
            window.location.href = 'login.html';
        }
    </script>
</body>
</html>
